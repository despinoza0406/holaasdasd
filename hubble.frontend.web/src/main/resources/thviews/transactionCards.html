<!DOCTYPE html>
<html>
<div th:replace="mainTemplates/header"></div>
<body>
  <div th:replace="mainTemplates/navbar"></div>
  <div th:replace="mainTemplates/detailsModal"></div>
  
  <div class="container top-buffer">
    <h4 >Aplicacion</h4>
    <div class="row d-flex">
      <div class="col-sm-6 col-md-4 col-lg-4 d-flex" th:each="transaction, iter : ${transactions}">
        <div class="card top-buffer" style="border-color: #2E2E2E;border-style: solid;border-width: 1px;border-radius: 3px;" >
          <div class="card-block">
            <a href="#"><h4 class="card-title" th:text="${transaction.displayName}"></h4></a>
            <table class="table table-hover">
              <thead>
                <tr>
                  <th></th>
                  <th>Última Hora</th>
                  <th>Últimos 10 Minutos</th>
                  <th><i class="fa fa-cloud-download" style="font-size: 17px;" data-toggle="tooltip" data-placement="top" title="Medicion ultimos 60 minutos" ></i>
                  </th>
                  <th><i class="fa fa-cloud-download" style="font-size: 17px;" data-toggle="tooltip" data-placement="top" title="Medicion ultimos 10 minutos"></i></th>
                </tr>
                <tbody>
                  <tr>
                    <td><i class="fa fa-calendar" title="Indica disponibilidad" data-toggle="tooltip" data-placement="top"></i>
                    </td>
                    <td th:text="${availabilityLastHourAvgs[iter.index].average}+'%'"></td>
                    <td th:text="${availabilityLast10MinutesAvgs[iter.index].average}+'%'"></td>
                    <td th:id="${transaction.id}+'_id_disponibilidad_60'" class="icon-center"></td>
                    <td th:id="${transaction.id}+'_id_disponibilidad_10'" class="icon-center"></td>
                  </tr>
                  <tr>
                      <td><i class="fa fa-clock-o" title="Indica Performance" data-toggle="tooltip" data-placement="top"></i>
                    </td>
                    <td th:unless="${performanceLastHourAvgs[iter.index].average &lt; 0} " th:text="${performanceLastHourAvgs[iter.index].average}/1000+'s'"></td>
                    <td th:unless="${performanceLast10MinutesAvgs[iter.index].average &lt; 0} " th:text="${performanceLast10MinutesAvgs[iter.index].average}/1000+'s'"></td>
                    <td th:if="${performanceLastHourAvgs[iter.index].average &lt; 0} " th:text="${performanceLastHourAvgs[iter.index].average}+'s'"></td>
                    <td th:if="${performanceLast10MinutesAvgs[iter.index].average &lt; 0} " th:text="${performanceLast10MinutesAvgs[iter.index].average}+'s'"></td>
                    <td th:id="${transaction.id}+'_id_performance_60'" class="icon-center"></td>
                    <td th:id="${transaction.id}+'_id_performance_10'" class="icon-center"></td>
                  </tr>
                </tbody>
              </thead>
            </table>
            <h4 class="card-title icon-center" th:text="'Ultima Actualizacion: '+${now}"></h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/detailsModal.js"></script>
  <script src="/js/block_color_transfer.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    var transactionAvailabilityAvgData = [[${availabilityLast10MinutesAvgs}]];
    var transactionPerformanceAvgData = [[${performanceLastHourAvgs}]];
    var transactions = [[${transactions}]];
    
    var availabilitiesLastHour = [[${availabilitiesLastHour}]];
    var availabilitiesLast10Minutes = [[${availabilitiesLast10Minutes}]];
    var performancesLastHour = [[${performancesLastHour}]];
    var performancesLast10Minutes = [[${performancesLast10Minutes}]];
        
        
    for (i = 0; i < transactionAvailabilityAvgData.length; i++) {
      var id_object = transactionAvailabilityAvgData[i]["transaction"]["id"];
      setBlockColor(id_object+"_id_disponibilidad_60",transactionAvailabilityAvgData[i]["average"],id_object+"_id_disponibilidad_60");
      setBlockColor(id_object+"_id_disponibilidad_10",transactionAvailabilityAvgData[i]["average"],id_object+"_id_disponibilidad_10");
    }

    
    for (i = 0; i < transactionPerformanceAvgData.length; i++) {
      var id_object = transactionPerformanceAvgData[i]["transaction"]["id"];
      setBlockColor(id_object+"_id_performance_60",transactionPerformanceAvgData[i]["average"],id_object+"_id_performance_60");
      setBlockColor(id_object+"_id_performance_10",transactionPerformanceAvgData[i]["average"],id_object+"_id_performance_10");
    }
    
    $('#myModal').on('show.bs.modal', function (e) {
    var getIdFromRow = $(e.relatedTarget);
    for (var key in getIdFromRow[0]["id"]) {
        //alert(key);
    }
    fillModal(getIdFromRow[0].id);
     });
$("#myModal").on("hidden.bs.modal", function () {
    $("#myModalData").html("");
    $("#myModalHead").html("");
});

function fillModal(id) {
    
    var idList = id.split("_");
    var transactionId = idList[0];
    var collection = idList[2];
    var period = idList[3];
    var data;
    var description = "";
    
    document.getElementById("modal_title").textContent = "Detalle de mediciones";
    
    if(collection == "performance"){
        if(period=="60"){
            data = performancesLastHour;
            description = "Performance última Hora"
        }
        if(period=="10"){
            data = performancesLast10Minutes;
            description = "Performance últimos 10 Minutos"
        }          
    }    
    if(collection == "disponibilidad"){
        if(period=="60"){
            data = availabilitiesLastHour;
            description = "Disponibilidad última Hora"
        }
        if(period=="10"){
            data = availabilitiesLast10Minutes;
            description = "Disponibilidad últimos 10 Minutos"
        }   
    }
    
    document.getElementById("modal_button_pressed").textContent = description;
    
    //var obj = dataList[0]['disponibilidadPerformance' + idList[2] + '10MinutosList'];
    //document.getElementById("modal_title").textContent = dataList[0]['displayName'];
    //

    if(collection == "disponibilidad"){
        $('#myModalHead').append('<tr><th>Fecha y Hora</th><th>Transacción</th><th>Locación</th><th>Estado de Disponibilidad</th><th>Cantidad de warnings</th></tr>');
        for (i = 0; i < data.length; i++) { 
            if(data[i]['transaction']['id']==transactionId)
                $('#myModalData').append('<tr><td>' + data[i]['timeStamp'] + '</td><td>' + data[i]['transaction']['name'] + '</td><td>' + data[i]['location']['name'] + '</td><td>' + data[i]['status'] + '</td><td>' + data[i]['numberOfErrors'] + '</td><td>');
        }
    }
    if(collection == "performance"){
        $('#myModalHead').append('<tr><th>Fecha y Hora</th><th>Transacción</th><th>Locación</th><th>Tiempo de Respuesta</th></tr>');
        for (i = 0; i < data.length; i++) { 
            if(data[i]['transaction']['id']==transactionId)
                $('#myModalData').append('<tr><td>' + data[i]['timeStamp'] + '</td><td>' + data[i]['transaction']['name'] + '</td><td>' + data[i]['location']['name'] + '</td><td>' + data[i]['responseTime'] + '</td><td>');
        }
    }
}
    /*]]>*/

  </script>
  <div th:replace="mainTemplates/footer"></div>
</body>
</html>
